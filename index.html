<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat Firebase</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chat-area { display: none; }
    #user-list li { cursor: pointer; margin: 5px 0; }
    #messages { border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 10px; margin-top: 10px; }
    input, button { margin-top: 10px; padding: 5px; }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
</head>
<body>
  <h1>Chat Firebase</h1>

  <div id="login-area">
    <button id="login-btn">Login com Google</button>
  </div>

  <div id="chat-area">
    <h3>Usuários para conversar:</h3>
    <ul id="user-list"></ul>

    <div id="chat-box">
      <h3>Mensagens</h3>
      <div id="messages"></div>
      <input type="text" id="message-input" placeholder="Digite uma mensagem" />
      <button id="send-btn">Enviar</button>
    </div>
  </div>

  <script>
    // CONFIGURAÇÃO DO FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyATG5P2NvdecjCPO7gzFNGs6l7plDrxY04",
      authDomain: "sdel-16c6a.firebaseapp.com",
      projectId: "sdel-16c6a",
      storageBucket: "sdel-16c6a.firebasestorage.app",
      messagingSenderId: "676676370586",
      appId: "1:676676370586:web:444947d3dda78a80d9df23",
      measurementId: "G-FZWQ9FYZG5"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let selectedUser = null;
    let chatUnsub = null;

    // LOGIN
    document.getElementById("login-btn").onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    // MONITORAR AUTENTICAÇÃO
    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        document.getElementById("login-area").style.display = "none";
        document.getElementById("chat-area").style.display = "block";

        // Salvar usuário no Firestore
        await db.collection("users").doc(user.uid).set({
          name: user.displayName,
          email: user.email,
          photoURL: user.photoURL
        }, { merge: true });

        loadUsers();
      }
    });

    // CARREGAR USUÁRIOS
    async function loadUsers() {
      const userList = document.getElementById("user-list");
      userList.innerHTML = "";
      const snapshot = await db.collection("users").get();
      snapshot.forEach(doc => {
        if (doc.id !== currentUser.uid) {
          const li = document.createElement("li");
          li.textContent = doc.data().name;
          li.onclick = () => selectUser(doc.id, doc.data().name);
          userList.appendChild(li);
        }
      });
    }

    // SELECIONAR USUÁRIO PARA CONVERSA
    function selectUser(uid, name) {
      selectedUser = uid;
      document.getElementById("messages").innerHTML = "";
      if (chatUnsub) chatUnsub();

      const chatId = [currentUser.uid, uid].sort().join("_");

      chatUnsub = db.collection("chats").doc(chatId)
        .onSnapshot(doc => {
          const data = doc.data();
          const messages = data?.messages || [];
          const msgBox = document.getElementById("messages");
          msgBox.innerHTML = messages.map(msg => 
            `<div><strong>${msg.sender === currentUser.uid ? "Você" : name}:</strong> ${msg.text}</div>`
          ).join("");
          msgBox.scrollTop = msgBox.scrollHeight;
        });
    }

    // ENVIAR MENSAGEM
    document.getElementById("send-btn").onclick = async () => {
      const text = document.getElementById("message-input").value;
      if (!text || !selectedUser) return;

      const chatId = [currentUser.uid, selectedUser].sort().join("_");
      const chatRef = db.collection("chats").doc(chatId);

      await chatRef.set({
        users: [currentUser.uid, selectedUser],
        messages: firebase.firestore.FieldValue.arrayUnion({
          sender: currentUser.uid,
          text,
          timestamp: firebase.firestore.Timestamp.now()
        })
      }, { merge: true });

      document.getElementById("message-input").value = "";
    };
  </script>
</body>
</html>
